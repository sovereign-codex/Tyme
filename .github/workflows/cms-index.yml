name: CMS Index Builder

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'CMS/**'
      - 'manifest/**'
      - '.github/workflows/cms-index.yml'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate cms-index.json
        run: |
          mkdir -p manifest
          python - << 'EOF'
          import json, os
          cms_root = "CMS"
          entries = []
          for root, dirs, files in os.walk(cms_root):
              for f in files:
                  if f.endswith((".md", ".txt", ".json")):
                      path = os.path.join(root, f)
                      entries.append({"path": path.replace("\\","/")})
          os.makedirs("manifest", exist_ok=True)
          with open("manifest/cms-index.json","w") as fp:
              json.dump({"cms_files": entries}, fp, indent=2)
          EOF

      - name: Commit cms-index.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "$(git status --porcelain manifest/cms-index.json)" ]]; then
            git config user.name "tyme-workflow"
            git config user.email "actions@users.noreply.github.com"
            git add manifest/cms-index.json
            git commit -m "chore: update cms-index"
            git push
          else
            echo "No changes to commit."
          fi
