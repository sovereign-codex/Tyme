name: WorkflowGrid Status

on:
  schedule:
    - cron: '0 * * * *'   # every hour
  workflow_dispatch:
  push:
    paths:
      - 'manifest/**'
      - 'heartbeat/**'
      - '.github/workflows/workflow-status.yml'

jobs:
  build-status:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build workflow status JSON + HTML
        run: |
          mkdir -p manifest docs
          python - << 'EOF'
          import json, os
          from datetime import datetime, timezone

          def load_json(path):
              if not os.path.exists(path):
                  return None
              try:
                  with open(path) as f:
                      return json.load(f)
              except Exception:
                  return None

          now = datetime.now(timezone.utc).isoformat()

          avot = load_json("heartbeat/avot-heartbeat.json")
          cms = load_json("manifest/cms-index.json")
          site = load_json("manifest/site-map.json")
          subnet = load_json("manifest/subnet-status.json")

          status = {
              "generated_at": now,
              "components": {
                  "avot_heartbeat": {
                      "ok": avot is not None,
                      "last_beat": (avot or {}).get("last_beat") if isinstance(avot, dict) else None,
                  },
                  "cms_index": {
                      "ok": cms is not None,
                      "files_indexed": len((cms or {}).get("cms_files", [])) if isinstance(cms, dict) else 0,
                  },
                  "site_map": {
                      "ok": site is not None,
                      "files_tracked": len((site or {}).get("files", [])) if isinstance(site, dict) else 0,
                  },
                  "subnet_sync": {
                      "ok": subnet is not None,
                      "last_update": (subnet or {}).get("updated_at") if isinstance(subnet, dict) else None,
                      "files_tracked": len((subnet or {}).get("files", [])) if isinstance(subnet, dict) else 0,
                  },
              },
          }

          os.makedirs("manifest", exist_ok=True)
          with open("manifest/workflow-status.json", "w") as f:
              json.dump(status, f, indent=2)

          # Build simple HTML dashboard
          def badge(ok):
              color = "#22c55e" if ok else "#ef4444"
              label = "OK" if ok else "Missing"
              return f'<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:{color};color:white;font-size:12px;">{label}</span>'

          c = status["components"]
          html = f"""<!DOCTYPE html>
          <html lang=\"en\">
          <head>
            <meta charset=\"UTF-8\">
            <title>Tyme WorkflowGrid Status</title>
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
            <style>
              body {{
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                padding: 1.5rem;
                background: #050816;
                color: #f9fafb;
              }}
              .card {{
                border-radius: 0.75rem;
                padding: 1rem 1.25rem;
                margin-bottom: 1rem;
                background: rgba(15,23,42,0.95);
                border: 1px solid rgba(148,163,184,0.3);
              }}
              .title {{
                font-size: 1.4rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
              }}
              .subtitle {{
                font-size: 0.9rem;
                color: #9ca3af;
                margin-bottom: 1rem;
              }}
              .row {{
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0.25rem 0;
                font-size: 0.95rem;
              }}
              .label {{
                color: #e5e7eb;
              }}
              code {{
                font-size: 0.8rem;
                background: rgba(15,23,42,0.9);
                padding: 0.15rem 0.35rem;
                border-radius: 0.35rem;
              }}
            </style>
          </head>
          <body>
            <div class="card">
              <div class="title">Tyme WorkflowGrid Status</div>
              <div class="subtitle">
                Generated at <code>{status["generated_at"]}</code> (UTC)<br/>
                This dashboard reflects the latest JSON manifest at <code>manifest/workflow-status.json</code>.
              </div>

              <div class="row">
                <div class="label">AVOT Heartbeat</div>
                <div>{badge(c["avot_heartbeat"]["ok"])}</div>
              </div>
              <div class="row">
                <div class="label">Last beat</div>
                <div><code>{c["avot_heartbeat"]["last_beat"]}</code></div>
              </div>

              <hr style="border-color: rgba(55,65,81,0.8);margin: 0.75rem 0;" />

              <div class="row">
                <div class="label">CMS Index</div>
                <div>{badge(c["cms_index"]["ok"])}</div>
              </div>
              <div class="row">
                <div class="label">CMS files indexed</div>
                <div><code>{c["cms_index"]["files_indexed"]}</code></div>
              </div>

              <hr style="border-color: rgba(55,65,81,0.8);margin: 0.75rem 0;" />

              <div class="row">
                <div class="label">Convergence Site Map</div>
                <div>{badge(c["site_map"]["ok"])}</div>
              </div>
              <div class="row">
                <div class="label">Files tracked</div>
                <div><code>{c["site_map"]["files_tracked"]}</code></div>
              </div>

              <hr style="border-color: rgba(55,65,81,0.8);margin: 0.75rem 0;" />

              <div class="row">
                <div class="label">Subnet Covenant Sync</div>
                <div>{badge(c["subnet_sync"]["ok"])}</div>
              </div>
              <div class="row">
                <div class="label">Last covenant update</div>
                <div><code>{c["subnet_sync"]["last_update"]}</code></div>
              </div>
              <div class="row">
                <div class="label">Covenant files tracked</div>
                <div><code>{c["subnet_sync"]["files_tracked"]}</code></div>
              </div>
            </div>
          </body>
          </html>
          """

          with open("docs/workflow-status.html", "w", encoding="utf-8") as f:
              f.write(html)
          EOF

      - name: Commit status outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "$(git status --porcelain manifest/workflow-status.json docs/workflow-status.html)" ]]; then
            git config user.name "tyme-workflow"
            git config user.email "actions@users.noreply.github.com"
            git add manifest/workflow-status.json docs/workflow-status.html
            git commit -m "chore: update WorkflowGrid status"
            git push
          else
            echo "No status changes to commit."
          fi
